
<!DOCTYPE html >
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>
			Using GeoJSON
		</title>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://d3js.org/colorbrewer.v1.min.js"></script>

		<style type="text/css">



		.brush .extent {
  		stroke: #000;
  		fill-opacity: .125;
 		shape-rendering: crispEdges;
		}

		div.tooltip {	
		    position: absolute;			
		    text-align: center;			
		    width: 80px;					
		    height: 40px;					
		    padding: 2px;				
		    font: 12px sans-serif;		
		    background: lightsteelblue;	
		    border: 0px;		
		    border-radius: 8px;			
		    pointer-events: none;			
		}

		</style>
	</head>
	<body>
		<h1> Exploring ObamaCare </h1>
		 <div id="addPane">

<body>

<select>
  
  <optgroup label="Race">
     <option value="mercedes">All Races</option>
    <option value="mercedes">Black</option>
    <option value="audi">White</option>
     <option value="mercedes">Latino</option>
  </optgroup>
</select>
      <select>
  
  <optgroup label="Race">
     <option value="mercedes">All Income</option>
    <option value="mercedes">1</option>
    <option value="audi">2</option>
     <option value="mercedes">3</option>
     <option value="audi">4</option>
     <option value="mercedes">5</option>
  </optgroup>
</select>
     
     

  </div>

		<script type="text/javascript">

		// create an SVG region in the usual way
		var width = 800, height = 500;


		var svg = d3.select("body")
				.append("svg")
				.attr({"width":width, "height":height});

		var drawData, mapData, currentYear, selectedRace, allData, raceData, incomeData; 

		// create a projection that provides our mapping from lat,lon data to x,y, coordiantes
		var projection = d3.geo.albersUsa()
				.translate([width/2, height/2]);

		// create a path tool that will translate GeoJSON into SVG path data
		var path = d3.geo.path().projection(projection);

		// create our coloring tool
		var color = d3.scale.quantize()
		.range(colorbrewer.YlGnBu[8]);

		// Define the div for the tooltip
		var div = d3.select("body").append("div")	
		    .attr("class", "tooltip")				
		    .style("opacity", 0);

		// the metric we are showing -- obviously, it would not take much to make this as interactive as the
		// first example

		// set the year and redraw map. 



			//d3.slider().axis(true).min(2000).max(2100).step(5)




		//set the new Year and redraw the Vis 
		function setYear(year){
			console.log("setYear got called!");
			currentYear = year;
			drawVis(); 
		}

		if (currentYear === undefined){
			currentYear = "2006"; 
		}





		//draw the Visualization


		//sets up mapData for the general visualization with no categories 
		function visGeneral(){
				// build the popup menu



				var censusData = drawData[currentYear]["states"];

				var censusMap = d3.map();
				censusData.forEach(function(d){censusMap.set(d.NAME,d)});

				// loop through all of the path data, attaching the appropriate
				// record to each one based on the name
				for (var i = 0; i < mapData.features.length; i++){
					var name = mapData.features[i].properties.name;
					mapData.features[i].properties.value = censusMap.get(name);
				}
			
			
		} 


		function visRaces(){

				drawData = raceData;

				//some deafult sor TESTING //TODO automate this accordingly 

				selectedRace = 3; 


				//populate censusData 

				var censusData = drawData[currentYear];

				var censusMap = d3.map();

				for (var state in censusData){ 

					if (censusData.hasOwnProperty(state)){

						//calling this the same variables as generaVis for testing 
						newObj = {"NAME": state, "PUI": censusData[state][selectedRace][0], "RACE_DESC": censusData[state][selectedRace][1]}

						censusMap.set(state, newObj); 
					}
				}
				//censusData.forEach(function(d){censusMap.set(d.NAME,d)});

				// loop through all of the path data, attaching the appropriate
				// record to each one based on the name
				for (var i = 0; i < mapData.features.length; i++){ //TODO ensure that mapData refreshes everytime 
					var name = mapData.features[i].properties.name;
					mapData.features[i].properties.value = censusMap.get(name);
				}
		}


		//draw the map 
		function drawVis(){

				//set the color domain 
				drawData = allData; 

				//set the color domain 
				colorObject = d3.values(drawData); 

				var max = d3.max(colorObject, function(yearData) {
		 			 return d3.max(yearData["states"], function(d){ 
		 			 	return +d["PUI"]; 
		 			 });
				});

				var min = d3.min(colorObject, function(yearData) {
		 			 return d3.min(yearData["states"], function(d){ 
		 			 	return +d["PUI"]; 
		 			 });
				});

				color.domain([0, 50]);


				// call the visualtion for non specific data 

				//visGeneral()

				visRaces();

				// create the states in the SVG
				var states = svg.selectAll("path")
				.data(mapData.features); 

				states.exit()
					.transition()
					.duration(10)
					.remove(); 
				
				states.enter()
					.append("path")
					.attr("d", path)
					.attr("class","state");

				// style each state to set the fill color based on our metric
				states
					.style("fill", function(d){
					if (d.properties.value){
						return color(+d.properties.value["PUI"]);
					}	else{
						return "red";
					}

				})
			  .on("mouseover", function(d) {		
	            div.transition()		
	                .duration(200)		
	                .style("opacity", .9);		
	            div	.html(currentYear + "<br/>"  + d.properties.value["NAME"] + "<br/>"  + d.properties.value["PUI"].substring(0,4) +" %" )	//d.properties.value["PUI"].substring(0,4)
	                .style("left", (d3.event.pageX) + "px")		
	                .style("top", (d3.event.pageY - 28) + "px");	
	            })					
		        .on("mouseout", function(d) {		
		            div.transition()		
		                .duration(500)		
		                .style("opacity", 0);	
		        }); 


		}

		// gives us a data for a given year from the general data
		var getyeardata=function ( dataobj, year){
			//console.log("this function has been called");
			 var yeardata=[];
			dataobj.forEach(function(element){
				for (prop in element){
			//console.log(prop);
			if (prop==year){
				//console.log(year)
				yeardata.push(element[prop]);
				//console.log(ydata[0]);
			}
		}

			})
		
			
		return yeardata;
		};
		var getstatedata=function(datarray, state){
			var statedata=[];
			datarray.forEach(function(e){
				e.forEach(function(element){
					if (element[0]==state) {
					statedata.push(element)
				}
				})
				//console.log(element[0]);
				
			})
			return statedata;
		}

		var getraceData= function(data, race){
			var racedata=[]
		}



		// fetch our data -- first the map, and then the CSV data (the order matters little here since we
		// are not displaying anything until the binding is done)
		d3.json("http://www.cs.middlebury.edu/~candrews/classes/infovis/data/us-states.json", 
			function(inputMapData){
			d3.json("race_new_Data.json", function(race_Data){
				//console.log(race_Data);
				raceData = race_Data; 
				//console.log("the following is the racedata");
				//console.log(race_Data);
			
				d3.json("income_data.txt", function (dataset) {
					var generalobject={};
					var details={yes:70,no:30}
					var raceobject={0:details,1:details,2:details,3:details,4:details,5:details};
					var raceArray={all:raceobject,Blacks:raceobject,white:raceobject,Hispanic:raceobject}
				var extracted=getyeardata(dataset,2006);
				var al=getstatedata(extracted,"Alabama");
				console.log(al);
					generalobject["race"]=raceArray;
					console.log("testing");
					//console.log(getyeardata(dataset,2006));
				


					//var incomebject={};

					//console.log("income");
					//console.log(dataset[0]);
					//console.log(getyeardata(dataset, "2009"));
					allData = dataset;
					mapData = inputMapData; 

					//var states=Object.keys(dataset[0][0]);
					//console.log(dataset[0]["2006"]);
					var years = Object.keys(dataset); 
					//console.log(years);

					//d3.selectAll('#metrics').remove();

					var menu = d3.select("#metrics");
					
					years.forEach(function(d){
					 	//console.log(d);
						menu.append("option").attr("value",d).text(d);
					}); 

					drawVis(); 

					// set the behavior on a change to the menu (i.e., update the coloring)
					d3.select("select").on("change", function () {
						//console.log("change happened!");
						setYear(this.value);
						});

					// create a map of our census data, so we can easily find records
					// correspondng to a particular stat
				});
			});
		});




		</script>

		<select><optgroup label="Metrics" id="metrics"></optgroup></select>

<div>

</div>


	</body>
</html>
