
<!DOCTYPE html >
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>
			Using GeoJSON
		</title>
		  <link rel="stylesheet" href="d3.slider.css" />  
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
		<script src="d3.slider.js"></script>

		<style type="text/css">



		.brush .extent {
  		stroke: #000;
  		fill-opacity: .125;
 		shape-rendering: crispEdges;
		}

		div.tooltip {	
		    position: absolute;			
		    text-align: center;			
		    width: 80px;					
		    height: 40px;					
		    padding: 2px;				
		    font: 12px sans-serif;		
		    background: lightsteelblue;	
		    border: 0px;		
		    border-radius: 8px;			
		    pointer-events: none;			
		}

		/* Styling for the line charts 
			Adapted from Mike Bostock 
			http://bl.ocks.org/d3noob/8603837
		*/
		path { 
			stroke-width: 1;
			fill: none;
		}
		.linesvg{
			border: 1px solid grey;
			margin-bottom: 100px;
    		margin-right: 150px;
    		margin-top: 100px;
		}
	/*	 .axis {
      fill:none;
      stroke:gray;
      stroke-opacity:0.3;
    }*/


/*			.axis path,
			.axis line {
				fill: none;
				stroke: grey;
				stroke-width: 1;
				shape-rendering: crispEdges;
			}			
*/
/*.body{
height:auto;
min-height: 100%;
border: 3px solid gray;	
}*/
#wrapper {
	/*height:auto;*/
	/*min-height: 100%;*/
  width:100%;
  /*clear:both;*/
  /*border: 3px solid grey;*/

}
#mapdiv {
 
  /*width:800px;*/
  float:left;
}
#linediv {

  width:32%;
  float:left;
}

#slider6{
	clear: both;
	top: 30px;
	left: 150px;

}
		</style>
	</head>
	<body>
		<h1> Exploring ObamaCare </h1>
		<!--  <div id="addPane"> -->

<body>
	<div id="selectmetric"> 
		<select id= "races">
  
		  <optgroup label="Race">
		     <option value=0>All Races</option>
		    <option value=1>White alone, not Hispanic</option>
		    <option value=2>Black alone, not Hispanic</option>
		     <option value=3>Hispanic (any race)</option>
		  </optgroup>
		</select>

	 <select id = "years">

		<optgroup label="Metrics" id="metrics"></optgroup>


	</select>

	<select id="incomes">
		<optgroup label="Income Levels" id="income_metric"></optgroup>
	</select>
	</div>
<div id="wrapper">
  <div id="mapdiv">
 

	</div>

  </div>
  <div id="linediv"></div>
<!-- </div> -->
 	<div id= "slider6"> 
 		  <h2> Current Years <span id="slider6text">2006</span></h2>
 	</div>
    
  
    
    <!-- <div id="slider6"></div> -->



 

  </div>

		<script type="text/javascript">


		// create an SVG region in the usual way

		/*TODO 	
			* Clean up global variables 
			* Remove print statements 
			* Styling 
			* Legends 
			* Clean up directory - get rid of unnecessary files 
			* Global min and global max 
		*/


		var width = 800, height = 500;


		var svg = d3.selectAll("#mapdiv")
				.append("svg")
				.attr({"width":width, "height":height});

		var visData, drawData, lineData, mapData, currentYear, currentRace, currentIncome, currentState, currentMetric, allData, raceData, incomeData, maxValue, minValue; 

		maxValue = 0; //defaults for max an min
		minValue  = 100 // defaults for 

		var years=["2006","2007","2008","2009","2010","2011","2012","2013"];
		var racelist=[0,1,2,3];
		var incomelist = [0,1,2,3,4,5]

		var statesNames = []; 
		// create a projection that provides our mapping from lat,lon data to x,y, coordiantes
		var projection = d3.geo.albersUsa()
				.scale(1000)
				.translate([width/2, height/2]);

		// create a path tool that will translate GeoJSON into SVG path data
		var path = d3.geo.path().projection(projection);

		// create our coloring tool
		var color = d3.scale.quantize()
		.range(colorbrewer.YlGnBu[8]);

		// Define the div for the tooltip
		var div = d3.select("body").append("div")	
		    .attr("class", "tooltip")				
		    .style("opacity", 0);



		//set the new Year and redraw the Vis 
		function setYear(year){
			console.log("setYear got called! Year: ", year);
			currentYear = year;
			drawVis(); 

			//if selected income is valid for new year, update income list but retain income level for visualization 


			incMenu();
		}

		//set the new Race and redraw the Vis 
		function setRace(race){
			console.log("setRace got called! : ",race);
			currentRace = race;
			drawVis(); 
		}

		//set the new Income and redraw the Vis 
		function setIncome(income){
			//console.log("setRace got called! : ",race);
			currentIncome = income;
			//incMenu();
			drawVis(); 
		}


		if (currentYear === undefined){
			currentYear = "2006"; 
		}
		//current race default 
		if (currentRace === undefined){
			currentRace = 0; 

		//currentIncome default 
		}if (currentIncome === undefined){
			currentIncome = 0; 
		}		


		function incMenu (){

			var incNames = ["All Income", "<= 200% of Poverty", "<= 250% of Poverty", "<= 138% of Poverty", "<= 400% of Poverty", "138% to 400% of Poverty"];


						//d3.selectAll("#invValName").remove();
			var menu2 = d3.select("#income_metric");
			// var parent=document.getElementBId("income_metric");
			//menu2.remove();
			// var child=document.getElementsByClassName("incValName");
			menu2.selectAll(".incValName").remove(); 
			// parent.removeChild(child);
				
				incomelist.forEach(function(d){
				 	//console.log(d);

				 	var incValid = visData[currentYear]["Alabama"][currentRace][d];
				 	if (incValid != undefined){
				 		console.log("incValid", incValid);
				 		menu2.append("option").attr("value",d).classed("incValName", true).text(incNames[d]);
				 	}
					
				}); 

		}

		//execute once for the first year. 


		//draw the Visualization


		//sets up mapData for the general visualization with no categories 
		function visGeneral(){
				// build the popup menu

				var censusData = getNewStateData(); 
				var censusMap = d3.map();
				censusData.forEach(function(d){censusMap.set(d.NAME,d)});

				// loop through all of the path data, attaching the appropriate
				// record to each one based on the name
				for (var i = 0; i < mapData.features.length; i++){
					var name = mapData.features[i].properties.name;
					mapData.features[i].properties.value = censusMap.get(name);
				}
			
			
		} 


		function getNewStateData(){
			var statesArray = [];
			var yearData = visData[currentYear];
			for (var state in yearData){
				var stateStr = String(state); 

				var PUI = yearData[stateStr][currentRace][currentIncome];
				var obj = {"NAME": stateStr, "PUI": PUI}
				statesArray.push(obj);
			}
	
			return statesArray; 

		} 


		//draw the map 
		function drawVis(){

				//set the color domain 
				drawData = allData; 

				colorObject = d3.values(drawData); 

				// var max = d3.max(colorObject, function(yearData) {
		 	// 		 return d3.max(yearData["states"], function(d){ 
		 	// 		 	return +d["PUI"]; 
		 	// 		 });
				// });

				// var min = d3.min(colorObject, function(yearData) {
		 	// 		 return d3.min(yearData["states"], function(d){ 
		 	// 		 	return +d["PUI"]; 
		 	// 		 });
				// });

				//var max 

				color.domain([0, 55]);


				// call the visualtion for non specific data 





				visGeneral();


				//Populate the income value menu 




				// create the states in the SVG
				var states = svg.selectAll("path")
				.data(mapData.features); 

				states.exit()
					.transition()
					.duration(10)
					.remove(); 
				
				states.enter()
					.append("path")
					.attr("d", path)
					.attr("class","state");

				// style each state to set the fill color based on our metric
				states
					.style("fill", function(d){
					if (d.properties.value){
						return color(+d.properties.value["PUI"]);
					}	else{
						return "red";
					}

				})
			  .on("mouseover", function(d) {		
	            div.transition()		
	                .duration(200)		
	                .style("opacity", .9);		
	            div	.html(currentYear + "<br/>"  + d.properties.value["NAME"] + "<br/>"  + d.properties.value["PUI"].substring(0,4) +" %" )	//d.properties.value["PUI"].substring(0,4)
	                .style("left", (d3.event.pageX) + "px")		
	                .style("top", (d3.event.pageY - 28) + "px");	
	            })					
		        .on("mouseout", function(d) {		
		            div.transition()		
		                .duration(500)		
		                .style("opacity", 0);	
		        })
		        .on("click", function(d) {
		        	var clicked_state = d.properties.value["NAME"]; 
		        	console.log(clicked_state, "got clicked!");
		        	currentState = clicked_state;
		        	drawLineCharts();
		        }
		        );


		}

		/* Draws the line charts for the selected state 

			Adapted from Mike Bostock 
				http://bl.ocks.org/d3noob/8603837
		*/

 

		function drawLineCharts(){
			currentMetric = "Race";
				var data = lineData[currentState][currentMetric]; 
				console.log("line");
				console.log(lineData);


				//compute global max and min for PUI


				for (var state in lineData){
					//console.
					var stateData = lineData[state];
					var raceData = stateData["Race"];
					var incData = stateData["Income"];

					var raceMax = d3.max(raceData, function(d){

				      		return d3.max(d["values"], function (e){
				      				return +e.PUI;
				      			});
				      	});

					console.log("Racemax", raceMax);


					var incMax = d3.max(incData, function(d){

				      		return d3.max(d["values"], function (e){
				      				return +e.PUI;
				      			});
				      	});
					console.log("INcmaxx", incMax);


					var maxVal = d3.max([incMax, incData]);
					//console.log("uuuuuuu" +d3.max([2,5]))
					maxValue=d3.max([maxValue,maxVal]);
					


				}

				     		 var xmax = d3.max(data, function(d){

					      		return d3.max(d["values"], function (e){
					      				return +e.year;
					      			});
					      	});



				console.log("maxvla", maxValue);
				var width = 500; 
		      	var height =400; 
		      	var margins = {top:60, bottom: 60, left: 60, right:60};
		     	var chartWidth = width - margins.left - margins.right;
		      	var chartHeight = height - margins.top - margins.bottom;
		      	var ymax = d3.max(data,function(d){return +d.PUI;});

		      	var ymax = d3.max(data, function(d){
		      		return d3.max(d["values"], function (e){
		      			console.log("PUI", e["PUI"]);
		      				return +e.PUI;//e["PUI"];
		      			}
		      			);

		      	});
		      	

	     		 var xmax = d3.max(data, function(d){

		      		return d3.max(d["values"], function (e){
		      				return +e.year;
		      			});
		      	});


	     		 var ymin = d3.min(data, function(d){
		      		return d3.min(d["values"], function (e){
		      				return +e.PUI;
		      			}
		      			);

		      	});
	     		 var xmin = d3.min(data, function(d){

		      		return d3.min(d["values"], function (e){
		      				return +e.year;
		      			}
		      			);

		      	});
	     		 
	     		console.log("Ymax: ", ymax, "Ymin: ", ymin);

	     		var ymax = ymax+10;
	      		var xScale = d3.scale.linear().range([0,chartWidth],.1).nice().domain([2006,2013]);
	      		var yScale = d3.scale.linear().range([chartHeight, 0]).nice().domain([0, ymax]);
	      		var lineColor = d3.scale.ordinal()
						  .domain(1,5)
						  .range([ "rgb(153, 107, 195)", "rgb(56, 106, 197)", "rgb(93, 199, 76)", "rgb(223, 199, 31)", "rgb(234, 118, 47)"]);


				 var line = d3.svg.line()
				 		.defined(function(d){return d.PUI;})
					    .x(function(d) {  return xScale(+d.year); })
					    .y(function(d) { return yScale(+d.PUI); });


				      // var legend = d3.legend.color()
					     //    .labelFormat(d3.format(".2f"))
					     //    .scale(lineColor)
					     //    .title("Income Level");
				
				// if (!clicked){

						d3.select('body').selectAll('.linesvg').remove();

						 var svg = d3.select("#linediv")
							      .append('svg')
							      .classed("linesvg", true)
							      .attr({
							        width:width,
							        height:height
							      });

						  svg.selectAll("g").remove();
						
					      var chart = svg.append("g")
					      .attr("transform","translate("+margins.left + "," + margins.top + ")");


					      var xAxis = d3.svg.axis()
					      .scale(xScale)
					      .orient("bottom")
					      .tickFormat(d3.format("d"));


					      chart.append("g")
						      .attr("class","axis")
						      .attr("transform", "translate(0, " + chartHeight+")")
						      .call(xAxis)
						      .append("text")
						      .attr({
						        "x":chartWidth/2,
						        "y":margins.bottom/2,
						              "text-anchor":"middle" // set so the (x,y) of the text is in the middle bottom
						            })
						      .text("year");

						var yAxis = d3.svg.axis()
						      .scale(yScale)
						      .orient("left")
						      .innerTickSize(-chartWidth)
						      .outerTickSize(0)
						      .tickPadding(10);

						      chart.append("g")
						      .attr("class","axis")
						      .call(yAxis)
						      .append("text")
						      .attr({
						        "x":-chartHeight/2,
						        "y":3 * -margins.left/4,
						        "text-anchor":"middle",
						        "transform" : "rotate(-90)"
						      })
						      .text("PUI");

						 var counter = 0;
						 data.forEach(function(d){
						 	//console.log("d.values" , d.values);
						 	counter++; 
					        chart.append("path")

					        .datum(d.values)	
					        .attr("class", "line")
					        .attr("d", line)
					        .style("stroke", function(d, i){
					        	// console.log("operat", counter);  
					        	return lineColor(counter);

					        }); //function(d, i){  return lineColor(d.year)}); //function(d){return lineColor(d[0].year);}

					        //var ln=chart.selectAll(".line");

					      	//chart.exit().remove();

					      // chart.append("g")
					      // 	.datum(d.values)
					      //   .attr("transform", "translate("+(30)+","+(50)+")")
					      //   .attr("class","legend")
					      //   .call(legend);


					       //  chart.selectAll('circle')
						      // .datum(d.values, function(e,i){ return e[i]})
						      // .enter()
						      // .append('circle')
						      // .attr({
							     //    cx:function(d){console.log("d.year in cx", +d.year); return xScale(+d.year);},
							     //    cy:function(d){return yScale(+d.PUI);},
							     //    r:function(d){return 2;}
							     //  });


			    		  });
			}

		
	

	

		// gives us a data for a given year from the general data
		var getyeardata=function ( dataobj, year){
			 var yeardata=[];
			dataobj.forEach(function(element){
				for (prop in element){
			if (prop==year){
				yeardata.push(element[prop]);
			}
		}

			})
		
			
		return yeardata;
		};
		var getstatedata=function(datarray, state){
			var statedata=[];
			datarray.forEach(function(e){
				e.forEach(function(element){
					if (element[0]==state) {
					statedata.push(element)
				}
				})
				
			})
			return statedata;
		}

		var getraceData= function(datarray, race){
			var racedata=[]
			datarray.forEach(function(data){
				if (data[2]==race) {
					racedata.push(data);
				}
			})
			return racedata;
		}

		var getincomedata=function(datarray, income){
			  var value;
			 datarray.forEach(function(data){
			 	if (+data[4]==income) {
					value=data[5];
				}

			 })
			 
		return value;
		}



		// Function that creates our main Object // visData. 
		function createObject(dataset){

			var yearObj = {} 
			years.forEach(function(year){
				var yearData = getyeardata(dataset, year);
				var stateObj = {}
				statesNames.forEach(function(state){
					var stateData = getstatedata(yearData, state);

					var raceObj = {}
					racelist.forEach(function(race){
						var raceData = getraceData(stateData, race);

						var incomeObj = {}
						incomelist.forEach(function(income){
							var incomeRaceData = getincomedata(raceData, income);
							incomeObj[income] = incomeRaceData; 

						});

						raceObj[race] = incomeObj; 
					}); 

					stateObj[state] = raceObj; 

				});

				yearObj[year] = stateObj; 

			}); 
			return yearObj; 
		}	


		function createLineData(myobj){
			function parser (obj){
				var newObj = {}; 
				statesNames.forEach(function(state){

					stateIncome = [];
					stateIncome["Income"] = [];
					stateIncome["Race"] = [];

					incomelist.forEach(function(income){
						//loop throught the years 
						var incValues = {};
						var raceValues = {};
						incValues["key"] = income; 
						incValues["values"] = [];
						incValsArray = [] 
						raceValues["values"] = []
						years.forEach(function(yr){
							var inc=obj[yr][state][0][income];

							var incobj = {"year": yr, "PUI": inc}; 
							incValues["values"].push(incobj); 
							
							if (income < 4){ //valid for getting race value 
						        raceValues["key"] = income
								var race = obj[yr][state][income][0] //get all races for 
								var raceobj = {"year": yr, "PUI": race};

								raceValues["values"].push(raceobj); 
							}

						});
						stateIncome["Income"].push(incValues);// = incValues;


						if (income < 4){ //Adding races which go till 4 
							stateIncome["Race"].push(raceValues); 
						}
						

					}); 

				newObj[state] = stateIncome; 

				});

				return newObj; 

			}

			return parser(myobj);

		}




		// fetch our data -- first the map, and then the CSV data (the order matters little here since we
		// are not displaying anything until the binding is done)
		d3.json("http://www.cs.middlebury.edu/~candrews/classes/infovis/data/us-states.json", 
			function(inputMapData){
			d3.json("race_new_Data.json", function(race_Data){
				raceData = race_Data; 
			
				d3.json("income_data.txt", function (dataset) {
					//console.log()


					var array= dataset[0][2006];
					for (var i = 1; i < 52; i++) {
						statesNames.push(array[i][0]);
					}

					visData = createObject(dataset); //create general object. 
					//console.log(visData);
					lineData = createLineData(visData); //create object for drawing line charts
						
					allData = dataset;

					mapData = inputMapData; 

					console.log(visData);

					var big={};
					var o={};
					var racelist=[0,1,2,3];
					

				

					years.forEach(function (yr) {
						big [yr]=statesNames;
					})



					var menu = d3.select("#metrics");
					
					years.forEach(function(d){
					 	//console.log(d);
						menu.append("option").attr("value",d).text(d);
					}); 


					incMenu(); 
					drawVis(); 


					d3.select("#years").on("change", function () {
						setYear(this.value);
						});
					d3.select("#races").on("change", function () {
						console.log("change happened! races :", this.value);

						setRace(this.value);
						});
					d3.select("#incomes").on("change", function () {
						console.log("change happened! in incomes:", this.value);

						setIncome(this.value);

						});


				    d3.select('#slider6').call(d3.slider().axis(false).min(2006).max(2013).step(1).on("slide", function(evt, value) {
				    	console.log("value", value);
				      d3.select('#slider6text').text(value);
				      setYear(value);
				    }));

				});
			});
		});



		</script>

		

<div>

</div>




	</body>
</html>
